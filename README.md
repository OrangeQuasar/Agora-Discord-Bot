# Agora-Discord-Bot

## 🎙️ 概要

このプログラム（**Agora-Discord-Bot**）は、Discord上で動作する**読み上げBot（TTS Bot）**です。

VOICEVOXエンジンを利用して、テキストチャットの内容をボイスチャンネルで自動的に読み上げます。複数のキャラクター音声に対応し、ユーザーごとに好みのキャラクターを設定できます。さらに、音楽再生や動画保存などのマルチメディア機能も備えています。

---

## 📋 主な機能

### 🔊 読み上げ機能
- **チャット読み上げ**: ユーザーがテキストチャンネルに入力した内容を、VOICEVOXのキャラクター音声で自動的に読み上げます
- **添付ファイル認識**: 画像、動画、音声、テキストファイルなどが添付された場合、ファイルタイプを読み上げます
  - 例：「画像ファイル添付」「動画ファイル添付」など
- **音声ファイル再生**: 設定により、添付された音声ファイルを直接再生することも可能
- **URL省略**: チャット内のURLは「リンク省略」と読み上げられます
- **ネタバレ防止**: `||`で囲まれた伏せ字テキストは「センシティブ発言」と読み上げられます

### 🎭 ユーザー設定・辞書機能
- **キャラクター変更**: ユーザーごとに読み上げキャラクター（ずんだもん、四国めたん、白上フブキなど）を設定・保存できます
- **辞書登録**: 特殊な読み方をする単語を辞書に登録して、正しく読み上げさせることができます

### 🎵 メディア機能
- **再生対応サイト**: YouTube / SoundCloud / Twitter(X) のURLから音声を抽出してボイスチャンネルで再生
- **動画・音声ダウンロード**: 指定したURLの動画や音声をサーバー上にダウンロード・保存（サイト別に最適な形式を選択）

---

## 🛠️ コマンド一覧

### 接続・切断
| コマンド | 説明 |
|---------|------|
| `!join` | ボイスチャンネルに接続・移動 |
| `!leave` | ボイスチャンネルから切断 |

### 再生・停止
| コマンド | 説明 |
|---------|------|
| `!stop` | 再生中の音声を停止 |
| `!play <url>` | YouTube / SoundCloud / Twitter(X) の音声を再生 |

### ユーザー設定
| コマンド | 説明 |
|---------|------|
| `!set <ユーザー名> <キャラクター名>` | 指定ユーザーのキャラクターを設定 |
| `!char` | 使用可能なキャラクター一覧を表示 |
| `!audioplay <true\|false>` | 音声ファイル再生設定を変更（true: 再生 / false: 再生しない） |

### 辞書管理
| コマンド | 説明 |
|---------|------|
| `!add <単語> <カタカナ読み>` | 辞書に単語を登録 |
| `!delete <単語>` | 辞書から単語を削除 |

### ダウンロード
| コマンド | 説明 |
|---------|------|
| `!save <video\|audio> <url>` | YouTube / SoundCloud / Twitter(X) の動画・音声をダウンロード |

### その他
| コマンド | 説明 |
|---------|------|
| `!help` | コマンドヘルプを表示 |

---

## 🚀 導入方法（Docker Compose）

### 前提条件
- Docker / Docker Compose がインストールされていること
- Discordの開発者ポータルでボットを作成済みであること
- VOICEVOXエンジンが起動可能な環境

### ステップ 1: 依存環境の確認

- Docker / Docker Compose がインストールされていること
- Discordの開発者ポータルでボットを作成済みであること
- VOICEVOXエンジン（コンテナで同梱、別途インストール不要）

このプロジェクトは Python 3.12 ベースのコンテナで動作し、依存関係は `uv` で管理されます（コンテナに同梱済み）。YouTube抽出のための JavaScript ランタイム（Node.js）もコンテナにインストールされます。

### ステップ 2: 設定ファイルの編集

`config.yaml` を開いて、以下の設定を行います：

```yaml
token: YOUR_DISCORD_BOT_TOKEN  # Discord Developer Portalで取得したトークンを入力
default_character_name: ずんだもん  # デフォルトキャラクター
character_map:
  ずんだもん: 3  # キャラクター名: VOICEVOXのキャラクターID
  四国めたん: 2
  # 他のキャラクターを追加...
VOICEVOX_URL: http://voicevox:50021  # VOICEVOXエンジンのURL（composeのサービス名）
audioplay: true  # 音声ファイル自動再生（true/false）
maintenance_mode: false  # メンテナンスモード
```

**Discord Botトークンの取得方法:**
1. [Discord Developer Portal](https://discord.com/developers/applications) にアクセス
2. 「New Application」をクリックして新しいアプリケーションを作成
3. 「Bot」タブから「Add Bot」をクリック
4. 「TOKEN」セクションで「Copy」をクリックしてトークンをコピー
5. 取得したトークンを `config.yaml` の `token` に貼り付け

### ステップ 3: ボットをサーバーに追加

1. Developer Portalの「OAuth2」→「URL Generator」に移動
2. 以下のスコープを選択: `bot`
3. 以下のパーミッションを選択:
   - `Send Messages`
   - `Connect`
   - `Speak`
4. 生成されたURLをブラウザで開いて、Botをサーバーに追加

### ステップ 3: ボットの起動

プロジェクトディレクトリで以下のコマンドを実行：

```bash
docker compose up -d --build
```

✅ ボットが起動しました！以降、サーバーの再起動時に自動的に起動されます。

### ボットの停止

```bash
docker compose down

### 補足（任意設定）
- Twitter(X)でログインが必要なメディアにアクセスする場合、Cookieの設定が必要になることがあります。その際は `yt-dlp` の CookieFile を使用する追加設定を検討してください（現状の機能では公開メディアに対して動作を想定）。
- 開発用途でダウンロードファイルの共有URLを自動出力したい場合は、`.env` に共有ベースURL（例: `SHARE_AUDIO_URL` / `SHARE_VIDEO_URL`）を設定し、開発モードの取り扱いにご注意ください。
```

---

## 📝 使用例

### キャラクター設定
```
!set @ユーザー名 四国めたん
```
→ 指定したユーザーの読み上げキャラクターを「四国めたん」に変更

### 辞書に単語を登録
```
!add Agora アゴラ
```
→ 「Agora」が「アゴラ」と読み上げられるようになります

### YouTubeから音声を再生
```
!play https://www.youtube.com/watch?v=xxxxx
```
→ 指定されたYouTubeの音声をボイスチャンネルで再生

### SoundCloudから音声を再生
```
!play https://soundcloud.com/artist/track
```
→ SoundCloudの音声をボイスチャンネルで再生

### Twitter(X)の動画を保存
```
!save video https://x.com/username/status/xxxxxxxxxxxxxx
```
→ 動画をmp4で保存（音声は `!save audio` でmp3保存）

---

## 🔧 トラブルシューティング

**Q: ボットが応答しない**
- ✅ ボットがボイスチャンネルに接続しているか確認（`!join`で接続）
- ✅ VOICEVOXエンジンが起動しているか確認
- ✅ トークンが正しく設定されているか確認

**Q: 音声が再生されない**
- ✅ ボイスチャンネルの接続を確認
- ✅ `!stop`で現在の再生を停止してから、もう一度試す
- ✅ YouTubeで403になる場合、再度 `docker compose build` でコンテナを再ビルド（ヘッダー/Node.jsが最新化されます）

**Q: 読み上げが変**
- ✅ `!add <単語> <カタカナ読み>`で辞書に登録して正しく読ませる

---

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。詳細は [LICENSE](LICENSE) を参照してください。
